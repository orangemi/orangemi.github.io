<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VuePress</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.87386866.css" as="style"><link rel="preload" href="/assets/js/app.9057a45e.js" as="script"><link rel="preload" href="/assets/js/2.8149e9c9.js" as="script"><link rel="preload" href="/assets/js/7.7ed49bf8.js" as="script"><link rel="prefetch" href="/assets/js/10.16c00290.js"><link rel="prefetch" href="/assets/js/11.5d2a6e9f.js"><link rel="prefetch" href="/assets/js/3.e26b2b52.js"><link rel="prefetch" href="/assets/js/4.8b9778bd.js"><link rel="prefetch" href="/assets/js/5.f6ed543a.js"><link rel="prefetch" href="/assets/js/6.decf63af.js"><link rel="prefetch" href="/assets/js/8.ac833798.js"><link rel="prefetch" href="/assets/js/9.c5b2df4d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.87386866.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="content default"><h1 id="cqrs研究"><a href="#cqrs研究" aria-hidden="true" class="header-anchor">#</a> CQRS研究</h1> <h1 id="cqrs-架构"><a href="#cqrs-架构" aria-hidden="true" class="header-anchor">#</a> CQRS 架构</h1> <p>Source: https://docs.microsoft.com/en-us/azure/architecture/guide/architecture-styles/cqrs</p> <h2 id="summary"><a href="#summary" aria-hidden="true" class="header-anchor">#</a> Summary</h2> <p>Command and Query Responsibility Segregation(CQRS)是一个将读和写操作分离的架构。</p> <p><img src="https://docs.microsoft.com/en-us/azure/architecture/guide/architecture-styles/images/cqrs-logical.svg" alt="image"></p> <p>在传统架构中，在同一个数据层面中进行查询和写入操作，对于普通的CRUD操作来说工作的还不错。然而，在复杂应用中，有些情景会变得很奇怪。例如在查询方面，应用会面对不同的查询语句，放回数据时需要将数据根据不同形态转换为对象，对象映射将变得复杂；在更新操作方面，数据写入时会有非常复杂的验证和业务逻辑。最终，数据模型层面会因为携带过多业务显得非常复杂。</p> <p>还有一个潜在的问题，很多时候查询和写入的负载有着不同的比例，经常有着非常不同的扩张策略。</p> <p>CQRS旨在利用分离读写模型解决上面所说的问题。使用命令(Command)写入数据，使用查询(Query)读取数据。</p> <ul><li>命令应该是基于业务的，不应该基于数据的（例如，“预定酒店房间”而不是“将预约状态修改”）。命令可以使用一个异步队列处理的，而不是同步处理的</li> <li>查询不应修改数据库，一个查询返回的数据不应该封装任何领域信息</li></ul> <p>更严谨完备的隔离读写操作，你应该将读写数据库从物理层分离。这样，数据结构可以为查询操作独立优化，例如，读取数据库可以存储一些冗余数据的视图模型(materialized view)，来避免在读取时使用复杂join或者关系模型。甚至可以使用另外一个类型数据库，例如，可以使用关系型数据库写入，而使用文档型数据库读取。</p> <p>使用不同的读写数据库，数据库之间的数据应该始终保持一致。通常在写任何数据的同时发出一个更新事件(event)来保持同步，写操作和事件应该在同一事务中发生。</p> <p>有些CQRS实现模型中使用“数据总线”(<a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/event-sourcing" target="_blank" rel="noopener noreferrer">Event Source pattern<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)，有了数据总线，应用数据状态可以由保存的一组事件序列来表示。 每一个事件都代表着数据的一组变化。数据的当前状态可以重放(replay)事件得到。在CQRS架构中，利用数据总线可以得到更多的好处，例如同一组的事件可以用于通知系统，用于通知其他组建，这里我们用于通知读取模型。读取模型实际上是利用事件序列来创建出一个数据当前状态的快照，可以使得查询更加有效。然而事件模型使得这个架构变得复杂。</p> <p><img src="https://docs.microsoft.com/en-us/azure/architecture/guide/architecture-styles/images/cqrs-events.svg" alt="image"></p> <h2 id="何时使用cqrs"><a href="#何时使用cqrs" aria-hidden="true" class="header-anchor">#</a> 何时使用CQRS</h2> <p>在协作领域中，当很多用户需要访问同一份数据，特别是当他们的查询场景和负载情况非常不同的时候，CQRS效果非常显著。</p> <p>CQRS不是在整个架构中处于顶级，在那些读写结果需要明显差异的子系统中实现CQRS，而其他情况可能会造成多余的复杂度，且没有好处。</p> <h2 id="好处"><a href="#好处" aria-hidden="true" class="header-anchor">#</a> 好处</h2> <ul><li>独立扩张：CQRS读写负载和模型完全独立，更少的产生锁问题</li> <li>优化数据结构：读模型中，可以优化查询，而写模型中，可以优化写入</li> <li>安全：在写入数据时更容易控制，只有在正确的领域实体中才能写入数据</li> <li>分离模型的优势：分离读写模型将变得可维护和可扩展。大部分复杂逻辑将应用在写模型上，读取模型变得相对简单</li> <li>查询简单：由于使用了视图模型，应用可以在查询时避免使用join</li></ul> <h2 id="挑战"><a href="#挑战" aria-hidden="true" class="header-anchor">#</a> 挑战</h2> <ul><li>实现复杂度：CQRS的概念是简单的，但这将带来一个复杂的应用架构，当他还包含数据总线</li> <li>消息队列：虽然CQRS不需要消息队列，但通常使用消息队列来处理写入数据和发送事件，如果是这样，应用本身需要处理写入失败或者重复写入或者丢失的情况。</li> <li>最终一致性：如果使用读写分离模型，数据读取可能会脏的或旧的</li></ul> <h2 id="最佳实践"><a href="#最佳实践" aria-hidden="true" class="header-anchor">#</a> 最佳实践</h2> <ul><li>详见<a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/cqrs" target="_blank" rel="noopener noreferrer">CQRS Pattern<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>数据总线来帮你避免更新中的冲突</li> <li>视图模型帮助你优化查询</li></ul> <h2 id="微服务中的cqrs"><a href="#微服务中的cqrs" aria-hidden="true" class="header-anchor">#</a> 微服务中的CQRS</h2> <p>CQRS在微服务架构中非常有优势，其中微服务架构一个重要特性就是：一个服务不能直接访问另外一个服务的数据（译者理解为领域数据）
<img src="https://docs.microsoft.com/en-us/azure/architecture/guide/architecture-styles/images/cqrs-microservices-wrong.png" alt="image"></p> <p>在接下来的图，服务A写入数据，服务B保持同步视图模型，服务A在写入数据的同时发布事件，服务B消费这个事件
<img src="https://docs.microsoft.com/en-us/azure/architecture/guide/architecture-styles/images/cqrs-microservices-right.png" alt="image"></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9057a45e.js" defer></script><script src="/assets/js/2.8149e9c9.js" defer></script><script src="/assets/js/7.7ed49bf8.js" defer></script>
  </body>
</html>
