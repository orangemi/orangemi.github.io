(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{211:function(t,a,s){"use strict";s.r(a);var e=s(2),r=Object(e.a)({},function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"ng-教你如何在-elasticsearch-重建索引"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ng-教你如何在-elasticsearch-重建索引","aria-hidden":"true"}},[t._v("#")]),t._v(" NG 教你如何在 Elasticsearch 重建索引")]),t._v(" "),s("h1",{attrs:{id:"ng-教你如何在-elasticsearch-重建索引-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ng-教你如何在-elasticsearch-重建索引-2","aria-hidden":"true"}},[t._v("#")]),t._v(" NG 教你如何在 Elasticsearch 重建索引")]),t._v(" "),s("h2",{attrs:{id:"序言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#序言","aria-hidden":"true"}},[t._v("#")]),t._v(" 序言")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://ws2.sinaimg.cn/large/56ff78c6gy1fqfhlwq6y5j21jw0kqjv8.jpg",alt:"image"}})]),t._v(" "),s("p",[s("a",{attrs:{href:"https://www.elastic.co",target:"_blank",rel:"noopener noreferrer"}},[t._v("Elasticsearch"),s("OutboundLink")],1),t._v(" 是一个实时的分布式搜索分析引擎。Teambition使用Elastisearch作为搜索引擎，为用户提供搜索服务，当我们决定存储某种数据时，我们需要使用"),s("code",[t._v("PUT /teambition")]),t._v("创建索引，在创建索引的时候需要将数据结构完整确定下来，于此同时索引的设定和很多固定配置将用不能改变。当需要改变数据结构时，就需要重新建立索引，为此，Elastic团队提供了很多辅助工具帮助开发人员进行重建索引。")]),t._v(" "),s("h2",{attrs:{id:"决定是否需要重建？"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#决定是否需要重建？","aria-hidden":"true"}},[t._v("#")]),t._v(" 决定是否需要重建？")]),t._v(" "),s("p",{attrs:{align:"center"}},[s("img",{staticStyle:{width:"300px"},attrs:{src:"https://ws2.sinaimg.cn/mw690/56ff78c6gy1fqfgdzl25qj20dw09xt8z.jpg"}})]),t._v(" "),s("p",[t._v("重建时相当痛苦的，如果没有很好的基础，服务可能中断，当数据量非常大时，重建恢复时间可能很长，甚至在重建过程中出错等等。所以，没有万不得已的情况下还是尽量避免重建索引。Teambition重建索引的理由略，因为这并不重要。")]),t._v(" "),s("h2",{attrs:{id:"使用正确的工具"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用正确的工具","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用正确的工具")]),t._v(" "),s("p",[t._v("kibana是Elasticsearch的最佳拍档，从ES 5.0开始，Kibana强大的功能能够替代几乎所有旧时代 ES 1.x 和 ES 2.x 的插件。关键是人家还是免费的！\n")]),s("p",{attrs:{align:"center"}},[s("img",{staticStyle:{width:"600px"},attrs:{src:"https://www.elastic.co/assets/blt3e85dcb3ff739ece/kibana50console.png"}})]),s("p"),t._v(" "),s("h2",{attrs:{id:"先决条件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#先决条件","aria-hidden":"true"}},[t._v("#")]),t._v(" 先决条件")]),t._v(" "),s("p",{attrs:{align:"center"}},[s("img",{attrs:{src:"https://wx3.sinaimg.cn/mw690/56ff78c6gy1fqfh5potrwj20e807pdfz.jpg",alt:"image"}})]),t._v(" "),s("p",[t._v("正在运行的服务必须使用别名(alias)来访问索引(index)，原因很简单，搜索服务最终要使用重建的索引，原始的索引将被删除。如果你的服务正在直接使用索引名，在重建前创建别名，更新服务。")]),t._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[t._v("POST /_aliases\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"actions"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"add"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"index"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"teambition"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 原有索引")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"alias"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"teambition_latest"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 服务的别名")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"先决条件2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#先决条件2","aria-hidden":"true"}},[t._v("#")]),t._v(" 先决条件2")]),t._v(" "),s("p",[t._v("记得查看Elasticsearch的Disk Usage，如果不够，请先申请好足够的空间。")]),t._v(" "),s("h2",{attrs:{id:"创建新索引"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建新索引","aria-hidden":"true"}},[t._v("#")]),t._v(" 创建新索引")]),t._v(" "),s("p",[t._v("和创建普通索引一样创建新索引。这里值得一提的时，当数据量很大的时候，需要设置刷新时间间隔，在此期间写入的数据不能搜到，从而提高重建速度："),s("code",[t._v("refresh_intervals = -1, number_of_replicas = 0")]),t._v("。实践告诉我，大概会提高100%~400%的提升。")]),t._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[t._v("PUT /teambition_"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("20180328")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"settings"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("..."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"mapping"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("..."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"记录同步数据的偏移值-offset"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#记录同步数据的偏移值-offset","aria-hidden":"true"}},[t._v("#")]),t._v(" 记录同步数据的偏移值(offset)")]),t._v(" "),s("p",[t._v("Teambition使用Kafka把MongoDB中的数据导入到Elasticsearch中，如果没有kafka，亦可读取oplog的数据写入Elasticsearch。无论使用哪种同步数据的方式，都需要记录同步数据的offset。重建索引可能非常耗时，在这段时间内，同步进程仍然在向旧索引更新数据，此时重建索引是无法更新这些新数据的。这里记录的方法就不多说了，Teambition使用"),s("a",{attrs:{href:"https://github.com/orangemi/kafka-admin",target:"_blank",rel:"noopener noreferrer"}},[t._v("kafka-admin"),s("OutboundLink")],1),t._v("的API记录offset。")]),t._v(" "),s("h2",{attrs:{id:"开始重建索引"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开始重建索引","aria-hidden":"true"}},[t._v("#")]),t._v(" 开始重建索引")]),t._v(" "),s("p",[t._v("使用Elasticsearch团队提供的reindex api就可以将数据copy到新索引中。这里几条路可以选：")]),t._v(" "),s("ol",[s("li",[t._v("当只是改变mapping数据结构时，可以仅仅使用reindex api即可。例如：删除字段，更新字段分词方式等。")]),t._v(" "),s("li",[t._v("当需要写入新的字段，新的字段是由老的字段计算得到时，可以使用"),s("code",[t._v("script")]),t._v("参数。例如，计算某条数据某字段的总和。script有很多坑，当script出错时，reindex跑了很久之后失败，即使将数据恢复，也需要重新跑reindex。")]),t._v(" "),s("li",[t._v("当含有很复杂的逻辑时，额，还是自己写程序吧。")])]),t._v(" "),s("p",[t._v("调用reindex接口，接口将会在reindex结束后返回，而接口返回超时只有30秒，如果reindex时间过长，建议加上"),s("code",[t._v("wait_for_completion=false")]),t._v("的参数条件，这样reindex将直接返回taskId")]),t._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[t._v("POST _reindex?wait_for_completion="),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"source"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"index"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"teambition"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"dest"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"index"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"teambition_20180328"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"script"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("..."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"重建索引中"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#重建索引中","aria-hidden":"true"}},[t._v("#")]),t._v(" 重建索引中")]),t._v(" "),s("p",[t._v("重建索引非常耗时，喝杯咖啡歇一会儿吧（顺便去打个球，睡个觉，旅个游）。\n"),s("img",{attrs:{src:"https://www.elastic.co/guide/en/kibana/current/monitoring/images/monitoring-overview.jpg",alt:""}})]),t._v(" "),s("p",[t._v("在没有设置 refresh_intervals 和 number_of_replicas 时，reindex的速度在 500~1000 doc/sec, 如果包含script时可能会更低。设置之后，可以到 4000~8000 doc/sec。 Teambition 70M Documents 大概耗时4小时。")]),t._v(" "),s("p",[t._v("可以使用"),s("code",[t._v("GET _tasks/{taskID}")]),t._v("可以看到重建进程，其中包含耗时，剩余doc数量等信息。")]),t._v(" "),s("p",[t._v("如果发现错误，可以使用"),s("code",[t._v("PUT _tasks/{taskID}/cancel")]),t._v("接口放弃任务，从头再来。")]),t._v(" "),s("h2",{attrs:{id:"恢复同步数据"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#恢复同步数据","aria-hidden":"true"}},[t._v("#")]),t._v(" 恢复同步数据")]),t._v(" "),s("p",[t._v("重建索引结束后，别忘了在"),s("code",[t._v("setting")]),t._v("中的将"),s("code",[t._v("number_of_replicas")]),t._v("和"),s("code",[t._v("refresh_intervals")]),t._v("设为原有值.\n启动新的同步索引的进程（从记录offset开始同步）")]),t._v(" "),s("h2",{attrs:{id:"建立新的alias"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#建立新的alias","aria-hidden":"true"}},[t._v("#")]),t._v(" 建立新的alias")]),t._v(" "),s("p",[t._v("需要在同时绑定建立的新索引以及解绑旧索引，语句如下：")]),t._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[t._v("POST _aliases\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"actions"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"add"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"index"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"teambition_20180328"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"alias"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"teambition_latest"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"remove"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"index"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"teambition"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"alias"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"teambition_latest"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"删掉index"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#删掉index","aria-hidden":"true"}},[t._v("#")]),t._v(" 删掉index")]),t._v(" "),s("p",[t._v("删除旧的index，释放磁盘空间；停止原有同步进程。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("DELETE teambition\n")])])]),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结","aria-hidden":"true"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("修改索引真的是一件费时费力的工作，特别是如果发生了错误，整个人都不好了。所以还是在创建索引的时候尽量想好能否满足需求，当然大家都知道这几乎是不可能的，因为存在着万恶的产品经理。")]),t._v(" "),s("p",[t._v("这里还有一个很重要的内容没有详细介绍就是同步进程，前面提到同步进程是将MongoDB的数据同步到ES中去的程序，这个程序同时还需要有能力暂停同步，重复同步的等能力。")]),t._v(" "),s("p",[t._v("最后欢迎大家使用"),s("a",{attrs:{href:"https://www.teambition.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("Teambition"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.technode.com/wp-content/uploads/2014/12/Teambition-logo.png",alt:"Teambition"}})])])},[],!1,null,null,null);a.default=r.exports}}]);